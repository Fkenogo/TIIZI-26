rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function groupDoc(groupId) {
      return get(/databases/$(database)/documents/groups/$(groupId));
    }

    function isGroupMember(groupId) {
      return signedIn()
        && groupDoc(groupId).data.memberIds != null
        && request.auth.uid in groupDoc(groupId).data.memberIds;
    }

    function isGroupAdmin(groupId) {
      return signedIn()
        && groupDoc(groupId).data.adminIds != null
        && request.auth.uid in groupDoc(groupId).data.adminIds;
    }

    function isMuted(groupId) {
      return groupDoc(groupId).data.mutedMemberIds != null
        && request.auth.uid in groupDoc(groupId).data.mutedMemberIds;
    }

    function isBanned(groupId) {
      return groupDoc(groupId).data.bannedMemberIds != null
        && request.auth.uid in groupDoc(groupId).data.bannedMemberIds;
    }

    function isPublicSelfJoin(groupId) {
      let changed = request.resource.data.diff(resource.data).affectedKeys();
      return signedIn()
        && resource.data.isPrivate != true
        && changed.hasOnly(['memberIds', 'memberCount'])
        && request.auth.uid in request.resource.data.memberIds
        && !(request.auth.uid in resource.data.memberIds)
        && request.resource.data.memberCount == resource.data.memberCount + 1;
    }

    function isMemberChallengeProgressUpdate(groupId) {
      let changed = request.resource.data.diff(resource.data).affectedKeys();
      return isGroupMember(groupId)
        && changed.hasOnly(['challengeProgress', 'challengeDay'])
        && request.resource.data.memberIds == resource.data.memberIds
        && request.resource.data.adminIds == resource.data.adminIds;
    }

    match /users/{userId} {
      allow read: if signedIn();
      allow create: if signedIn() && request.auth.uid == userId;
      allow update: if signedIn() && request.auth.uid == userId;
      allow delete: if false;

      match /followers/{followerId} {
        allow read: if signedIn() && (request.auth.uid == userId || request.auth.uid == followerId);
        allow create: if signedIn() && (request.auth.uid == followerId || request.auth.uid == userId);
        allow delete: if signedIn() && (request.auth.uid == followerId || request.auth.uid == userId);
      }

      match /following/{followingId} {
        allow read: if signedIn() && (request.auth.uid == userId || request.auth.uid == followingId);
        allow create: if signedIn() && (request.auth.uid == userId || request.auth.uid == followingId);
        allow delete: if signedIn() && (request.auth.uid == userId || request.auth.uid == followingId);
      }

      match /followRequests/{requestId} {
        allow read: if signedIn() && (request.auth.uid == userId || request.auth.uid == requestId);
        allow create: if signedIn() && request.auth.uid == requestId;
        allow update: if signedIn() && request.auth.uid == userId;
        allow delete: if signedIn() && request.auth.uid == userId;
      }

      match /notifications/{notificationId} {
        allow read: if signedIn() && request.auth.uid == userId;
        allow create: if signedIn();
        allow update: if signedIn() && request.auth.uid == userId;
        allow delete: if signedIn() && request.auth.uid == userId;
      }

      match /pledges/{pledgeId} {
        allow read, create, delete: if signedIn() && request.auth.uid == userId;
      }

      match /workouts/{workoutId} {
        allow read, create, update, delete: if signedIn() && request.auth.uid == userId;
      }

      match /exerciseFavorites/{favoriteId} {
        allow read, create, delete: if signedIn() && request.auth.uid == userId;
      }
    }

    match /groups/{groupId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn() && (
        isGroupAdmin(groupId)
        || isPublicSelfJoin(groupId)
        || isMemberChallengeProgressUpdate(groupId)
      );
      allow delete: if false;

      match /posts/{postId} {
        allow read: if signedIn() && isGroupMember(groupId);
        allow create: if signedIn() && isGroupMember(groupId) && !isMuted(groupId) && !isBanned(groupId);
        allow update, delete: if signedIn() && (request.auth.uid == resource.data.userId || isGroupAdmin(groupId));

        match /comments/{commentId} {
          allow read: if signedIn() && isGroupMember(groupId);
          allow create: if signedIn() && isGroupMember(groupId) && !isMuted(groupId) && !isBanned(groupId);
          allow update: if signedIn() && request.auth.uid == resource.data.userId;
          allow delete: if signedIn() && (request.auth.uid == resource.data.userId || isGroupAdmin(groupId));

          match /replies/{replyId} {
            allow read: if signedIn() && isGroupMember(groupId);
            allow create: if signedIn() && isGroupMember(groupId) && !isMuted(groupId) && !isBanned(groupId);
            allow update: if signedIn() && request.auth.uid == resource.data.userId;
            allow delete: if signedIn() && (request.auth.uid == resource.data.userId || isGroupAdmin(groupId));
          }
        }
      }

      match /messages/{messageId} {
        allow read: if signedIn() && isGroupMember(groupId);
        allow create: if signedIn() && isGroupMember(groupId) && !isMuted(groupId) && !isBanned(groupId);
        allow update, delete: if signedIn() && (request.auth.uid == resource.data.senderId || isGroupAdmin(groupId));
      }

      match /joinRequests/{requestId} {
        allow read: if signedIn() && isGroupAdmin(groupId);
        allow create: if signedIn() && request.auth.uid == requestId && !isGroupMember(groupId) && !isBanned(groupId);
        allow update: if signedIn() && isGroupAdmin(groupId);
        allow delete: if signedIn() && (request.auth.uid == requestId || isGroupAdmin(groupId));
      }

      match /supportRequests/{requestId} {
        allow read: if signedIn() && isGroupMember(groupId);
        allow create: if signedIn() && isGroupMember(groupId);
        allow update: if signedIn() && (request.auth.uid == resource.data.createdBy || isGroupAdmin(groupId));
        allow delete: if signedIn() && isGroupAdmin(groupId);

        match /comments/{commentId} {
          allow read: if signedIn() && isGroupMember(groupId);
          allow create: if signedIn() && isGroupMember(groupId);
          allow update: if signedIn() && request.auth.uid == resource.data.userId;
          allow delete: if signedIn() && (request.auth.uid == resource.data.userId || isGroupAdmin(groupId));
        }

        match /pledges/{pledgeId} {
          allow read: if signedIn() && isGroupMember(groupId);
          allow create: if signedIn() && isGroupMember(groupId);
          allow delete: if signedIn() && request.auth.uid == resource.data.userId;
        }
      }

      match /pledges/{pledgeId} {
        allow read: if signedIn() && isGroupMember(groupId);
        allow create: if signedIn() && isGroupMember(groupId);
      }

      match /adminTokens/{tokenId} {
        allow read, create, update, delete: if signedIn() && isGroupAdmin(groupId) && request.auth.uid == tokenId;
      }
    }

    match /analytics/{analyticsId} {
      allow read, create: if signedIn();
      allow update, delete: if false;
    }

    match /catalogExercises/{exerciseId} {
      allow read, create, update, delete: if signedIn();
    }

    match /catalogWorkoutPlans/{planId} {
      allow read, create, update, delete: if signedIn();
    }

    match /catalogBadges/{badgeId} {
      allow read, create, update, delete: if signedIn();
    }

    match /helpFaqs/{faqId} {
      allow read: if signedIn();
      allow create, update, delete: if signedIn();
    }
  }
}
